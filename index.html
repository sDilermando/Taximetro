<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Taxímetro PRO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --primary: #22c55e; /* Verde Dinheiro */
            --danger: #ef4444;
            --accent: #3b82f6;
            --text: #f8fafc;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* HEADER */
        .header {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid #334155;
        }
        .brand { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; }
        .brand span { color: var(--primary); }
        .gps-badge { 
            font-size: 0.7rem; background: rgba(34, 197, 94, 0.1); 
            color: var(--primary); padding: 4px 10px; border-radius: 20px; 
            border: 1px solid var(--primary); font-weight: bold;
            display: flex; align-items: center; gap: 5px;
        }
        .blink { animation: blinker 1.5s linear infinite; width:8px; height:8px; background:var(--primary); border-radius:50%; }
        @keyframes blinker { 50% { opacity: 0; } }

        /* PAINEL PRINCIPAL */
        .main-display {
            flex: 1; display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 70%);
        }

        .price-label { font-size: 0.9rem; color: #94a3b8; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; }
        .price-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 4.5rem; font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }
        .info-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            width: 100%; padding: 0 40px; margin-top: 30px;
        }
        .info-item { text-align: center; }
        .info-val { font-size: 1.5rem; font-weight: 700; color: white; }
        .info-lbl { font-size: 0.7rem; color: #64748b; text-transform: uppercase; }

        /* CONTROLES */
        .controls {
            background: #1e293b; padding: 25px;
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; gap: 15px;
        }

        .btn-row { display: flex; gap: 15px; }

        .btn-big {
            flex: 1; padding: 20px; border: none; border-radius: 16px;
            font-size: 1rem; font-weight: 800; text-transform: uppercase;
            cursor: pointer; transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            color: white; position: relative; overflow: hidden;
        }
        .btn-big:active { transform: scale(0.96); }

        .btn-start { background: linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
        .btn-stop { background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); }
        .btn-pause { background: #334155; color: #cbd5e1; }
        .btn-settings { background: #0f172a; color: #94a3b8; border: 1px solid #334155; width: 60px; }

        /* ÍCONES SVG */
        svg { width: 24px; height: 24px; fill: currentColor; }

        /* MODAL HISTÓRICO */
        .history-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: none; flex-direction: column; padding: 20px;
        }
        .history-list { overflow-y: auto; flex: 1; margin-top: 20px; }
        .history-item {
            background: #1e293b; padding: 15px; border-radius: 10px;
            margin-bottom: 10px; border-left: 4px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center;
        }

    </style>
</head>
<body>

    <div class="header">
        <div class="brand">TAXI<span>METER</span></div>
        <div class="gps-badge"><div class="blink"></div> GPS ATIVO</div>
        <button class="btn-big btn-settings" onclick="openSettings()" style="padding:10px;">
            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58z"/></svg>
        </button>
    </div>

    <div class="main-display">
        <div class="price-label">Valor Total</div>
        <div class="price-value" id="displayPrice">R$ 0,00</div>

        <div class="info-grid">
            <div class="info-item">
                <div class="info-val" id="displayDist">0.0</div>
                <div class="info-lbl">KM RODADOS</div>
            </div>
            <div class="info-item">
                <div class="info-val" id="displayTime">00:00</div>
                <div class="info-lbl">TEMPO</div>
            </div>
        </div>
        
        <div style="margin-top:20px;">
            <span id="tariffBadge" style="background:#334155; color:white; padding:5px 15px; border-radius:15px; font-size:0.8rem;">BANDEIRA 1</span>
        </div>
    </div>

    <div class="controls">
        <div class="btn-row" id="startRow">
            <button class="btn-big btn-start" onclick="startRace()">
                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> INICIAR CORRIDA
            </button>
        </div>

        <div class="btn-row" id="runningRow" style="display:none;">
            <button class="btn-big btn-pause" onclick="togglePause()" id="btnPause">
                <svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            <button class="btn-big btn-stop" onclick="finishRace()">
                <svg viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg> ENCERRAR
            </button>
        </div>

        <button onclick="showHistory()" style="background:transparent; color:#64748b; border:none; padding:10px; font-size:0.8rem; margin-top:5px;">VER HISTÓRICO DE CORRIDAS</button>
    </div>

    <div id="historyPanel" class="history-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; color:white;">
            <h2>Histórico</h2>
            <button onclick="document.getElementById('historyPanel').style.display='none'" style="background:none; border:none; color:white; font-size:1.5rem;">×</button>
        </div>
        <div id="historyList" class="history-list"></div>
    </div>

    <script>
        // CONFIG FIREBASE (Mesmas chaves do app Vagas)
        const firebaseConfig = {
            apiKey: "AIzaSyBzD2q7VWFM1jGqj-787M3AZV0_I9uFZ_s",
            authDomain: "vaga-especial-ff7d3.firebaseapp.com",
            databaseURL: "https://vaga-especial-ff7d3-default-rtdb.firebaseio.com",
            projectId: "vaga-especial-ff7d3",
            storageBucket: "vaga-especial-ff7d3.firebasestorage.app",
            messagingSenderId: "220203379880",
            appId: "1:220203379880:web:3ed69498dd1a7c3049e69d"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // CONFIGURAÇÕES PADRÃO (Salvas no LocalStorage)
        let config = JSON.parse(localStorage.getItem('taxi_config')) || {
            basePrice: 6.00, // Bandeirada
            priceKm: 3.50,   // Preço KM
            priceMin: 0.50,  // Preço Minuto Parado
            flag2: 20        // Acréscimo % Bandeira 2
        };

        // VARIÁVEIS DE CONTROLE
        let isRunning = false;
        let isPaused = false;
        let startTime = 0;
        let elapsedTime = 0;
        let totalDistance = 0;
        let lastLat = null;
        let lastLng = null;
        let timerInterval = null;
        let watchId = null;
        let currentFare = 0;
        let isFlag2 = false;

        // INICIALIZAÇÃO
        window.onload = () => {
            if(!navigator.geolocation) Swal.fire('Erro', 'Seu celular não tem GPS.', 'error');
            updateDisplay();
        };

        // --- LÓGICA DA CORRIDA ---

        function startRace() {
            Swal.fire({
                title: 'Iniciar Corrida?',
                text: `Bandeirada: R$ ${config.basePrice.toFixed(2)}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#22c55e',
                confirmButtonText: 'Iniciar'
            }).then((result) => {
                if (result.isConfirmed) {
                    isRunning = true;
                    isPaused = false;
                    startTime = Date.now();
                    elapsedTime = 0;
                    totalDistance = 0;
                    lastLat = null;
                    lastLng = null;
                    
                    // Verifica Bandeira 2 (Ex: noite ou domingo) - Lógica simples
                    const hour = new Date().getHours();
                    isFlag2 = (hour >= 20 || hour <= 6); // Automático após as 20h
                    document.getElementById('tariffBadge').innerText = isFlag2 ? "BANDEIRA 2 (+20%)" : "BANDEIRA 1";

                    // Interface
                    document.getElementById('startRow').style.display = 'none';
                    document.getElementById('runningRow').style.display = 'flex';
                    
                    // Inicia GPS e Timer
                    startGPS();
                    timerInterval = setInterval(updateTimer, 1000);
                }
            });
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('btnPause');
            if(isPaused) {
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>'; // Play Icon
                btn.style.background = '#eab308';
            } else {
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>'; // Pause Icon
                btn.style.background = '#334155';
            }
        }

        function finishRace() {
            clearInterval(timerInterval);
            navigator.geolocation.clearWatch(watchId);
            isRunning = false;

            // Salvar no Firebase
            const rideData = {
                date: new Date().toLocaleString(),
                distance: totalDistance.toFixed(2),
                time: formatTime(elapsedTime),
                price: currentFare.toFixed(2),
                flag: isFlag2 ? 2 : 1
            };
            db.ref('taxi_rides').push(rideData);

            // Mostrar Recibo
            Swal.fire({
                title: 'Corrida Finalizada',
                html: `
                    <div style="text-align:left; background:#f1f5f9; padding:15px; border-radius:10px; color:#0f172a;">
                        <h1 style="text-align:center; color:#22c55e; font-size:2.5rem; margin:0;">R$ ${currentFare.toFixed(2)}</h1>
                        <hr>
                        <p><strong>Distância:</strong> ${totalDistance.toFixed(2)} km</p>
                        <p><strong>Tempo:</strong> ${formatTime(elapsedTime)}</p>
                        <p><strong>Bandeira:</strong> ${isFlag2 ? '2' : '1'}</p>
                    </div>
                `,
                confirmButtonText: 'Nova Corrida',
                confirmButtonColor: '#0f172a'
            }).then(() => {
                resetApp();
            });
        }

        function resetApp() {
            document.getElementById('startRow').style.display = 'flex';
            document.getElementById('runningRow').style.display = 'none';
            totalDistance = 0;
            elapsedTime = 0;
            currentFare = 0;
            updateDisplay();
        }

        // --- CÁLCULOS ---

        function updateTimer() {
            if(!isPaused) {
                elapsedTime++;
                calculateFare();
                updateDisplay();
            }
        }

        function startGPS() {
            watchId = navigator.geolocation.watchPosition(pos => {
                if(isPaused) return;

                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;

                if(lastLat != null) {
                    const dist = getDist(lastLat, lastLng, lat, lng);
                    // Filtro de ruído: só conta se andou mais de 5 metros
                    if(dist > 0.005) { 
                        totalDistance += dist;
                        calculateFare();
                        updateDisplay();
                    }
                }
                lastLat = lat;
                lastLng = lng;

            }, err => console.error(err), { 
                enableHighAccuracy: true, 
                maximumAge: 0 
            });
        }

        function calculateFare() {
            // Fórmula: Bandeirada + (Km * PreçoKm) + (Minutos * PreçoMin)
            let fare = config.basePrice + (totalDistance * config.priceKm) + ((elapsedTime / 60) * config.priceMin);
            
            // Aplica Bandeira 2 se necessário
            if(isFlag2) {
                fare = fare * (1 + (config.flag2 / 100));
            }
            
            currentFare = fare;
        }

        function updateDisplay() {
            document.getElementById('displayPrice').innerText = `R$ ${currentFare.toFixed(2)}`;
            document.getElementById('displayDist').innerText = totalDistance.toFixed(1);
            document.getElementById('displayTime').innerText = formatTime(elapsedTime);
        }

        // --- SETTINGS (CONFIGURAÇÃO) ---
        async function openSettings() {
            const { value: formValues } = await Swal.fire({
                title: 'Configurar Tarifas',
                html: `
                    <label>Bandeirada (R$)</label>
                    <input id="swal-base" class="swal2-input" type="number" step="0.10" value="${config.basePrice}">
                    <label>Preço por KM (R$)</label>
                    <input id="swal-km" class="swal2-input" type="number" step="0.10" value="${config.priceKm}">
                    <label>Preço Minuto Parado (R$)</label>
                    <input id="swal-min" class="swal2-input" type="number" step="0.10" value="${config.priceMin}">
                `,
                focusConfirm: false,
                showCancelButton: true,
                preConfirm: () => {
                    return {
                        basePrice: parseFloat(document.getElementById('swal-base').value),
                        priceKm: parseFloat(document.getElementById('swal-km').value),
                        priceMin: parseFloat(document.getElementById('swal-min').value)
                    }
                }
            });

            if (formValues) {
                config = { ...config, ...formValues };
                localStorage.setItem('taxi_config', JSON.stringify(config));
                Swal.fire('Salvo', 'Novas tarifas aplicadas', 'success');
            }
        }

        // --- HISTÓRICO ---
        function showHistory() {
            const panel = document.getElementById('historyPanel');
            const list = document.getElementById('historyList');
            panel.style.display = 'flex';
            list.innerHTML = '<p style="color:#aaa; text-align:center;">Carregando...</p>';

            db.ref('taxi_rides').limitToLast(20).once('value').then(snap => {
                list.innerHTML = '';
                if(!snap.exists()) {
                    list.innerHTML = '<p style="color:#aaa; text-align:center;">Nenhuma corrida ainda.</p>';
                    return;
                }
                
                // Transforma objeto em array e inverte (mais recente primeiro)
                const rides = [];
                snap.forEach(c => rides.push(c.val()));
                rides.reverse();

                rides.forEach(r => {
                    list.innerHTML += `
                        <div class="history-item">
                            <div>
                                <div style="color:white; font-weight:bold;">R$ ${r.price}</div>
                                <div style="color:#64748b; font-size:0.75rem;">${r.date}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="color:#94a3b8; font-size:0.8rem;">${r.distance} km</div>
                                <div style="color:#94a3b8; font-size:0.8rem;">${r.time}</div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- UTILITÁRIOS ---
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

    </script>
</body>
</html>
