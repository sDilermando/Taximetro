<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Taximeter X</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- CORE SYSTEM (STARTUP GRADE) --- */
        :root {
            --bg: #0f172a; --panel: #1e293b; --primary: #22c55e;
            --accent: #3b82f6; --gold: #eab308; --danger: #ef4444;
            --text: #f8fafc; --gray: #94a3b8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }

        /* TRAVA A TELA NO CELULAR (APP NATIVO FEEL) */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100dvh; /* Dynamic Height */
            background-color: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Impede scroll da p√°gina inteira */
            position: fixed; /* Fixa o app na tela */
        }

        /* LAYOUT FLEX√çVEL VERTICAL */
        #app-container {
            display: flex; flex-direction: column;
            height: 100%; width: 100%;
            padding-bottom: env(safe-area-inset-bottom); /* Respeita iPhone X+ */
        }

        /* HEADER */
        header {
            flex: 0 0 60px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background: rgba(15, 23, 42, 0.98);
            border-bottom: 1px solid #334155; z-index: 20;
        }
        .logo { font-weight: 900; font-size: 1.2rem; letter-spacing: -1px; }
        .logo span { color: var(--primary); }
        .info-header { text-align: right; font-size: 0.75rem; line-height: 1.2; }
        .clock { color: var(--accent); font-family: 'JetBrains Mono'; font-weight: bold; }

        /* √ÅREA PRINCIPAL (CRESCE PARA OCUPAR O ESPA√áO) */
        main {
            flex: 1;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            position: relative;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 70%);
            padding: 10px;
        }

        .price-label { font-size: 0.7rem; letter-spacing: 2px; color: var(--gray); margin-bottom: 5px; text-transform: uppercase; }
        .price-val { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 4rem; font-weight: 700; color: var(--primary); 
            text-shadow: 0 0 30px rgba(34, 197, 94, 0.25);
            transition: color 0.3s;
        }
        
        /* BOT√ïES DE BANDEIRA */
        .flag-toggle {
            display: flex; background: #334155; border-radius: 50px; padding: 4px; margin-top: 15px;
            position: relative; z-index: 5;
        }
        .f-btn {
            background: transparent; border: none; color: var(--gray);
            padding: 8px 24px; border-radius: 40px; font-weight: 800; font-size: 0.8rem;
            cursor: pointer; transition: 0.2s;
        }
        .f-btn.active { background: var(--primary); color: #000; box-shadow: 0 4px 12px rgba(34,197,94,0.4); }
        .f-btn.active2 { background: var(--gold); color: #000; box-shadow: 0 4px 12px rgba(234,179,8,0.4); }
        .f-lock { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: var(--gold); display: none; white-space: nowrap; }

        /* GRID DE DADOS */
        .data-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            width: 100%; max-width: 380px; margin-top: 25px;
        }
        .data-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px; padding: 15px; text-align: center;
        }
        .d-val { font-size: 1.4rem; font-weight: 800; color: #fff; }
        .d-lbl { font-size: 0.6rem; color: var(--gray); text-transform: uppercase; margin-top: 2px; }

        /* √ÅREA DE CONTROLE (BOT√ïES GRANDES) */
        .control-area {
            padding: 15px 20px;
            background: var(--bg);
            border-top: 1px solid #1e293b;
            flex-shrink: 0; /* Impede que esmague */
        }
        .btn-xl {
            width: 100%; padding: 16px; border-radius: 14px; border: none;
            font-size: 1.1rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px;
            color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            touch-action: manipulation; /* REMOVE DELAY DO TOQUE */
        }
        .btn-xl:active { transform: scale(0.97); opacity: 0.9; }
        .bg-start { background: linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 6px 20px rgba(34,197,94,0.25); }
        .bg-stop { background: linear-gradient(135deg, #ef4444, #b91c1c); box-shadow: 0 6px 20px rgba(239,68,68,0.25); }
        .bg-pause { background: #334155; flex: 1; margin-right: 10px; }

        /* DOCK MENU (RODAP√â) */
        .dock {
            display: grid; grid-template-columns: repeat(5, 1fr);
            background: #0f172a; padding: 8px 0 20px 0; /* Extra padding bottom iOS */
            border-top: 1px solid #334155;
            flex-shrink: 0;
        }
        .dock-btn {
            background: none; border: none; color: #64748b;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            font-size: 0.6rem; font-weight: 700; padding: 5px; cursor: pointer;
        }
        .dock-btn svg { width: 22px; height: 22px; }
        .dock-btn:active { color: var(--primary); }

        /* MODAIS (GEN√âRICOS) */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 100; display: none; align-items: flex-end; justify-content: center;
        }
        .sheet {
            width: 100%; max-width: 600px; background: #1e293b;
            border-radius: 24px 24px 0 0; padding: 25px;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }
        .sheet-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        .sheet-title { font-size: 1.2rem; font-weight: 800; color: white; }
        .close-icon { font-size: 1.8rem; color: var(--gray); background: none; border: none; padding: 0 10px; }

        /* FORMUL√ÅRIOS */
        .inp-group { margin-bottom: 12px; }
        .inp-lbl { font-size: 0.7rem; color: var(--gray); display: block; margin-bottom: 5px; font-weight: 600; }
        .inp-field { 
            width: 100%; background: #0f172a; border: 1px solid #334155; 
            color: white; padding: 12px; border-radius: 10px; font-size: 1rem; 
        }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* MAPA */
        .map-box { width: 100%; height: 350px; background: #333; border-radius: 12px; margin-bottom: 15px; }
        .leaflet-control-geocoder { width: 100%; font-family: 'Inter'; }
        
        /* Scrollbar suave */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

    </style>
</head>
<body>

<div id="app-container">
    
    <header>
        <div class="logo">TAXI<span>X</span></div>
        <div class="info-header">
            <div class="clock" id="clock">00:00:00</div>
            <div id="driverDisplay">Mot: ...</div>
        </div>
    </header>

    <main>
        <div class="price-label">VALOR CORRIDA</div>
        <div class="price-val" id="displayVal">R$ 0,00</div>

        <div style="position: relative; margin-top: 10px;">
            <div class="f-lock" id="flagLock">üîí AUTO HOR√ÅRIO</div>
            <div class="flag-toggle">
                <button class="f-btn active" id="btnB1" onclick="manualFlag(1)">BAND 1</button>
                <button class="f-btn" id="btnB2" onclick="manualFlag(2)">BAND 2</button>
            </div>
        </div>

        <div class="data-grid">
            <div class="data-card">
                <div class="d-val" id="displayDist">0.0</div>
                <div class="d-lbl">KM (Cobrado > 1.5)</div>
            </div>
            <div class="data-card">
                <div class="d-val" id="displayTime">00:00</div>
                <div class="d-lbl">TEMPO TOTAL</div>
            </div>
        </div>
    </main>

    <div class="control-area">
        <div id="ctrl-start">
            <button class="btn-xl bg-start" onclick="iniciarCorrida()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                INICIAR CORRIDA
            </button>
        </div>
        <div id="ctrl-run" style="display:none; display:flex;">
            <button class="btn-xl bg-pause" id="btnPause" onclick="pausarCorrida()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            <button class="btn-xl bg-stop" onclick="encerrarCorrida()" style="flex:3">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
                ENCERRAR
            </button>
        </div>
    </div>

    <div class="dock">
        <button class="dock-btn" onclick="openModal('mdlSim')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
            Simular
        </button>
        <button class="dock-btn" onclick="carregarHistorico()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
            Hist√≥rico
        </button>
        <button class="dock-btn" onclick="shareApp()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
            App
        </button>
        <button class="dock-btn" onclick="abrirConfig()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58z"/></svg>
            Ajustes
        </button>
        <button class="dock-btn" onclick="openModal('mdlAdmin')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
            Admin
        </button>
    </div>

</div>

<div id="mdlConfig" class="overlay">
    <div class="sheet">
        <div class="sheet-head"><span class="sheet-title">Ajustes</span><button class="close-icon" onclick="closeModal('mdlConfig')">√ó</button></div>
        
        <div class="row-2">
            <div class="inp-group"><label class="inp-lbl">Band 1 (R$)</label><input type="number" id="c_b1" class="inp-field"></div>
            <div class="inp-group"><label class="inp-lbl">Km 1 (R$)</label><input type="number" id="c_k1" class="inp-field"></div>
        </div>
        <div class="row-2">
            <div class="inp-group"><label class="inp-lbl">Band 2 (R$)</label><input type="number" id="c_b2" class="inp-field"></div>
            <div class="inp-group"><label class="inp-lbl">Km 2 (R$)</label><input type="number" id="c_k2" class="inp-field"></div>
        </div>
        <div class="inp-group"><label class="inp-lbl">Minuto (R$)</label><input type="number" id="c_min" class="inp-field"></div>
        
        <div style="margin:10px 0; border-top:1px solid #334155;"></div>
        <div class="inp-lbl" style="color:var(--gold); margin-bottom:10px;">AUTO BANDEIRA 2 (HOR√ÅRIO)</div>
        <div class="row-2">
            <div class="inp-group"><label class="inp-lbl">In√≠cio (H)</label><input type="number" id="c_hi" class="inp-field"></div>
            <div class="inp-group"><label class="inp-lbl">Fim (H)</label><input type="number" id="c_hf" class="inp-field"></div>
        </div>

        <button class="btn-xl bg-start" onclick="salvarConfig()">SALVAR</button>
    </div>
</div>

<div id="mdlSim" class="overlay">
    <div class="sheet" style="height:90vh;">
        <div class="sheet-head"><span class="sheet-title">Simulador</span><button class="close-icon" onclick="closeModal('mdlSim')">√ó</button></div>
        <div id="map" class="map-box"></div>
        <div style="background:#0f172a; padding:15px; border-radius:12px; text-align:center; margin-bottom:15px;">
            <div class="inp-lbl">ESTIMATIVA</div>
            <div id="simPrice" style="font-size:2rem; font-weight:800; color:var(--primary)">R$ 0,00</div>
            <div id="simInfo" style="color:white; font-size:0.9rem;">0 km | 0 min</div>
        </div>
        <button class="btn-xl bg-pause" onclick="closeModal('mdlSim')">FECHAR</button>
    </div>
</div>

<div id="mdlHist" class="overlay">
    <div class="sheet">
        <div class="sheet-head"><span class="sheet-title">Hist√≥rico</span><button class="close-icon" onclick="closeModal('mdlHist')">√ó</button></div>
        <div id="histContent" style="flex:1; margin-bottom:15px;"></div>
        <button class="btn-xl bg-stop" onclick="limparHistorico()">LIMPAR TUDO</button>
    </div>
</div>

<div id="mdlAdmin" class="overlay">
    <div class="sheet">
        <div class="sheet-head"><span class="sheet-title">Admin</span><button class="close-icon" onclick="closeModal('mdlAdmin')">√ó</button></div>
        <div id="adminLogin">
            <input type="password" id="adminPass" class="inp-field" placeholder="Senha Mestra" style="text-align:center; margin-bottom:15px;">
            <button class="btn-xl bg-start" onclick="loginAdmin()">ENTRAR</button>
        </div>
        <div id="adminPanel" style="display:none;">
            <div id="driverList">Carregando...</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    // --- FIREBASE INIT ---
    const fbConfig = {
        apiKey: "AIzaSyBzD2q7VWFM1jGqj-787M3AZV0_I9uFZ_s",
        authDomain: "vaga-especial-ff7d3.firebaseapp.com",
        databaseURL: "https://vaga-especial-ff7d3-default-rtdb.firebaseio.com",
        projectId: "vaga-especial-ff7d3",
        storageBucket: "vaga-especial-ff7d3.firebasestorage.app",
        messagingSenderId: "220203379880",
        appId: "1:220203379880:web:3ed69498dd1a7c3049e69d"
    };
    try { firebase.initializeApp(fbConfig); } catch(e){}
    const db = firebase.database();

    // --- ESTADO DO APP ---
    let state = {
        rodando: false, pausado: false, flag: 1, manual: false,
        dist: 0, tempo: 0, valor: 0,
        driver: JSON.parse(localStorage.getItem('taxi_driver_x')) || null,
        cfg: JSON.parse(localStorage.getItem('taxi_cfg_x')) || { b1:6, k1:3.5, b2:8, k2:4.5, min:0.5, hi:22, hf:6 }
    };
    let timer, watch, lastPos, map, routeCtrl;

    // --- INICIO ---
    window.onload = () => {
        checkDriver();
        setInterval(updateClock, 1000);
        setInterval(checkAutoFlag, 60000); // Check flag every min
        checkAutoFlag();
        updateUI();
    };

    function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }

    async function checkDriver() {
        if(!state.driver) {
            const { value: d } = await Swal.fire({
                title: 'Cadastro Motorista',
                html: `<input id="sw-n" class="swal2-input" placeholder="Nome"><input id="sw-p" class="swal2-input" placeholder="Placa"><input id="sw-c" class="swal2-input" placeholder="Celular">`,
                allowOutsideClick: false,
                preConfirm: () => ({ name: document.getElementById('sw-n').value, plate: document.getElementById('sw-p').value, phone: document.getElementById('sw-c').value, id: Date.now() })
            });
            if(d) { state.driver = d; localStorage.setItem('taxi_driver_x', JSON.stringify(d)); db.ref('drivers/'+d.id).set(d); }
        }
        if(state.driver) document.getElementById('driverDisplay').innerHTML = `Mot: <b>${state.driver.name}</b>`;
    }

    // --- L√ìGICA DE TARIFAS ---
    function checkAutoFlag() {
        if(state.manual) return;
        const h = new Date().getHours();
        let isB2 = (state.cfg.hi > state.cfg.hf) ? (h >= state.cfg.hi || h < state.cfg.hf) : (h >= state.cfg.hi && h < state.cfg.hf);
        setFlag(isB2 ? 2 : 1, true);
    }

    function manualFlag(n) {
        if(document.getElementById('flagLock').style.display === 'block') return Swal.fire('Bloqueado', 'Hor√°rio Autom√°tico', 'warning');
        state.manual = true; setFlag(n, false);
    }

    function setFlag(n, lock) {
        state.flag = n;
        document.getElementById('btnB1').className = n===1 ? 'f-btn active' : 'f-btn';
        document.getElementById('btnB2').className = n===2 ? 'f-btn active2' : 'f-btn';
        document.getElementById('flagLock').style.display = lock ? 'block' : 'none';
        
        // Visual Lock
        const op = lock ? 0.5 : 1;
        document.getElementById('btnB1').style.opacity = op;
        document.getElementById('btnB2').style.opacity = op;

        if(state.rodando) calcPrice();
        else {
            let base = n===1 ? state.cfg.b1 : state.cfg.b2;
            document.getElementById('displayVal').innerText = `R$ ${base.toFixed(2)}`;
        }
    }

    function calcPrice() {
        // REGRA 1.5KM
        let b = state.flag===1 ? state.cfg.b1 : state.cfg.b2;
        let k = state.flag===1 ? state.cfg.k1 : state.cfg.k2;
        
        if(state.dist <= 1.5) {
            state.valor = b;
        } else {
            let exc = state.dist - 1.5;
            state.valor = b + (exc * k) + ((state.tempo/60) * state.cfg.min);
        }
        updateUI();
    }

    function updateUI() {
        document.getElementById('displayVal').innerText = `R$ ${state.valor.toFixed(2)}`;
        document.getElementById('displayDist').innerText = state.dist.toFixed(1);
        let m = Math.floor(state.tempo/60).toString().padStart(2,'0');
        let s = (state.tempo%60).toString().padStart(2,'0');
        document.getElementById('displayTime').innerText = `${m}:${s}`;
    }

    // --- CONTROLES ---
    function iniciarCorrida() {
        state.rodando = true; state.pausado = false; state.dist = 0; state.tempo = 0; state.manual = false;
        checkAutoFlag();
        document.getElementById('ctrl-start').style.display='none';
        document.getElementById('ctrl-run').style.display='flex';

        if(navigator.geolocation) {
            watch = navigator.geolocation.watchPosition(p => {
                if(state.rodando && !state.pausado) {
                    if(lastPos) {
                        let d = getDist(lastPos.coords.latitude, lastPos.coords.longitude, p.coords.latitude, p.coords.longitude);
                        if(d > 0.005) { state.dist += d; calcPrice(); }
                    }
                    lastPos = p;
                }
            }, null, { enableHighAccuracy: true });
        }
        timer = setInterval(() => {
            if(!state.pausado) { state.tempo++; calcPrice(); }
        }, 1000);
    }

    function pausarCorrida() {
        state.pausado = !state.pausado;
        const btn = document.getElementById('btnPause');
        btn.innerHTML = state.pausado ? '‚ñ∂' : '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
        btn.style.background = state.pausado ? '#eab308' : '#334155';
    }

    function encerrarCorrida() {
        clearInterval(timer); navigator.geolocation.clearWatch(watch);
        state.rodando = false;
        
        const r = {
            data: new Date().toLocaleString(),
            val: state.valor.toFixed(2),
            dist: state.dist.toFixed(2),
            tempo: document.getElementById('displayTime').innerText,
            flag: state.flag,
            mot: state.driver.name
        };
        db.ref('taxi_rides').push(r);

        Swal.fire({
            title: 'Finalizado',
            html: `<h1 style="color:#22c55e">R$ ${r.val}</h1><p>${r.dist}km | ${r.tempo}</p>`,
            showCancelButton: true, confirmButtonText: 'Nova', cancelButtonText: 'Recibo'
        }).then(res => {
            if(res.dismiss === Swal.DismissReason.cancel) {
                const t = `üöñ *T√°xi ${r.mot}*\nüí∞ R$ ${r.val}\nüèÅ ${r.dist}km\n‚è± ${r.tempo}`;
                if(navigator.share) navigator.share({text:t});
            }
            document.getElementById('ctrl-start').style.display='block';
            document.getElementById('ctrl-run').style.display='none';
            checkAutoFlag();
        });
    }

    // --- MODAIS E FUNCIONALIDADES ---
    function openModal(id) {
        document.getElementById(id).style.display = 'flex';
        if(id === 'mdlSim') initSim();
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // AJUSTES
    function abrirConfig() {
        document.getElementById('c_b1').value = state.cfg.b1;
        document.getElementById('c_k1').value = state.cfg.k1;
        document.getElementById('c_b2').value = state.cfg.b2;
        document.getElementById('c_k2').value = state.cfg.k2;
        document.getElementById('c_min').value = state.cfg.min;
        document.getElementById('c_hi').value = state.cfg.hi;
        document.getElementById('c_hf').value = state.cfg.hf;
        openModal('mdlConfig');
    }
    function salvarConfig() {
        state.cfg = {
            b1: parseFloat(document.getElementById('c_b1').value),
            k1: parseFloat(document.getElementById('c_k1').value),
            b2: parseFloat(document.getElementById('c_b2').value),
            k2: parseFloat(document.getElementById('c_k2').value),
            min: parseFloat(document.getElementById('c_min').value),
            hi: parseInt(document.getElementById('c_hi').value),
            hf: parseInt(document.getElementById('c_hf').value)
        };
        localStorage.setItem('taxi_cfg_x', JSON.stringify(state.cfg));
        closeModal('mdlConfig');
        checkAutoFlag();
        Swal.fire('Salvo', '', 'success');
    }

    // SIMULADOR
    function initSim() {
        setTimeout(() => {
            if(!map) {
                map = L.map('map').setView([-21, -44], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.Control.geocoder({ defaultMarkGeocode: false, placeholder:'Destino...' })
                .on('markgeocode', function(e) { calcRoute(e.geocode.center); }).addTo(map);
            }
            map.invalidateSize();
            navigator.geolocation.getCurrentPosition(p => {
                const me = [p.coords.latitude, p.coords.longitude];
                map.setView(me, 14); map.myPos = me;
                L.marker(me).addTo(map).bindPopup('Eu').openPopup();
            });
        }, 300);
    }
    function calcRoute(dest) {
        if(!map.myPos) return;
        if(routeCtrl) map.removeControl(routeCtrl);
        routeCtrl = L.Routing.control({
            waypoints: [ L.latLng(map.myPos), dest ],
            createMarker: () => null, show: false
        }).on('routesfound', e => {
            const d = e.routes[0].summary.totalDistance / 1000;
            const t = e.routes[0].summary.totalTime / 60;
            
            let b = state.flag===1 ? state.cfg.b1 : state.cfg.b2;
            let k = state.flag===1 ? state.cfg.k1 : state.cfg.k2;
            let tot = b;
            if(d > 1.5) tot += (d-1.5)*k;
            tot += t * state.cfg.min;

            document.getElementById('simPrice').innerText = `R$ ${tot.toFixed(2)}`;
            document.getElementById('simInfo').innerText = `${d.toFixed(1)} km | ${t.toFixed(0)} min`;
        }).addTo(map);
    }

    // HISTORICO
    function carregarHistorico() {
        openModal('mdlHist');
        db.ref('taxi_rides').limitToLast(20).once('value').then(s => {
            let h = '';
            let a = []; s.forEach(c => a.push(c.val()));
            a.reverse().forEach(r => {
                h += `<div style="background:rgba(255,255,255,0.05); padding:10px; margin-bottom:5px; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between;"><b>R$ ${r.val}</b> <small>${r.data}</small></div>
                    <small style="color:#aaa">${r.dist}km | ${r.tempo}</small>
                </div>`;
            });
            document.getElementById('histContent').innerHTML = h || 'Vazio';
        });
    }
    function limparHistorico() { if(confirm('Apagar?')) { db.ref('taxi_rides').remove(); document.getElementById('histContent').innerHTML=''; } }

    // ADMIN
    function loginAdmin() {
        if(document.getElementById('adminPass').value === 'sjdr2025') {
            document.getElementById('adminLogin').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadDrivers();
        } else Swal.fire('Erro', 'Senha', 'error');
    }
    function loadDrivers() {
        db.ref('drivers').once('value').then(s => {
            let h = ''; s.forEach(c => { let d=c.val(); h+= `<div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;"><div><b>${d.name}</b><br><small>${d.plate}</small></div><button onclick="delD(${d.id})" style="color:red; background:none; border:none;">X</button></div>`; });
            document.getElementById('driverList').innerHTML = h || 'Nenhum';
        });
    }
    function delD(id) { if(confirm('Bloquear?')) { db.ref('drivers/'+id).remove(); loadDrivers(); }}
    
    function shareApp() { if(navigator.share) navigator.share({title:'TaxiX', url:window.location.href}); }
    function getDist(lat1, lon1, lat2, lon2) { const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
</script>
</body>
</html>
