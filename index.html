<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tax√≠metro Pro V12</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- ESTILO NEON DARK --- */
        :root {
            --bg: #0f172a; 
            --panel: #1e293b; 
            --primary: #22c55e; 
            --accent: #3b82f6; 
            --gold: #eab308; 
            --text: #f8fafc;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0; width: 100%; height: 100vh;
            background-color: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif;
            display: flex; flex-direction: column;
            overflow: hidden; /* Evita rolagem da p√°gina inteira */
        }

        /* HEADER */
        .app-header {
            flex: 0 0 60px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px;
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid #334155;
            z-index: 50;
        }
        .brand { font-weight: 800; font-size: 1.1rem; letter-spacing: -0.5px; }
        .brand span { color: var(--primary); }
        .header-info { text-align: right; }
        .clock { color: var(--accent); font-family: 'JetBrains Mono', monospace; font-weight: bold; font-size: 0.9rem; }
        .driver { font-size: 0.7rem; color: #94a3b8; }
        .driver b { color: var(--gold); }

        /* √ÅREA PRINCIPAL (Mostrador) */
        .viewport {
            flex: 1;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 80%);
            padding: 20px;
            position: relative;
        }

        .label-price { font-size: 0.8rem; letter-spacing: 2px; color: #64748b; margin-bottom: 10px; text-transform: uppercase; }
        .value-price { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 4.5rem; 
            font-weight: 700; 
            color: var(--primary); 
            text-shadow: 0 0 30px rgba(34, 197, 94, 0.2);
            line-height: 1;
        }

        /* SELETOR BANDEIRA */
        .flag-box {
            display: flex; gap: 10px; margin-top: 20px;
            background: #334155; padding: 5px; border-radius: 50px;
        }
        .flag-btn {
            background: transparent; border: none; color: #94a3b8;
            padding: 8px 20px; border-radius: 20px;
            font-weight: bold; font-size: 0.8rem; cursor: pointer; transition: 0.2s;
        }
        .flag-btn.active { background: var(--primary); color: #000; box-shadow: 0 4px 10px rgba(34,197,94,0.3); }
        .flag-btn.active2 { background: var(--gold); color: #000; box-shadow: 0 4px 10px rgba(234,179,8,0.3); }
        .flag-lock { margin-top: 5px; font-size: 0.65rem; color: var(--gold); display: none; }

        /* GRID INFORMA√á√ïES */
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            width: 100%; max-width: 400px; margin-top: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.03); border-radius: 12px;
            padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05);
        }
        .stat-val { font-size: 1.4rem; font-weight: bold; color: white; }
        .stat-lbl { font-size: 0.6rem; color: #94a3b8; text-transform: uppercase; margin-top: 4px; }

        /* BOT√ïES DE A√á√ÉO */
        .action-area {
            padding: 20px;
            background: var(--bg);
        }
        .btn-main {
            width: 100%; padding: 18px; border: none; border-radius: 14px;
            font-size: 1.1rem; font-weight: 800; text-transform: uppercase;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            color: white; transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-start { background: linear-gradient(135deg, #22c55e, #166534); box-shadow: 0 4px 0 #14532d; }
        .btn-stop { background: linear-gradient(135deg, #ef4444, #991b1b); box-shadow: 0 4px 0 #7f1d1d; }
        .btn-pause { background: #334155; flex: 1; box-shadow: 0 4px 0 #1e293b; }

        /* MENU INFERIOR (DOCK) */
        .dock {
            display: grid; grid-template-columns: repeat(5, 1fr);
            background: #0f172a; border-top: 1px solid #334155;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .dock-btn {
            background: none; border: none; color: #64748b;
            padding: 12px 0; display: flex; flex-direction: column; align-items: center;
            font-size: 0.6rem; font-weight: 600; cursor: pointer;
        }
        .dock-btn svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .dock-btn:active { color: var(--primary); background: rgba(255,255,255,0.05); }

        /* MODAIS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000;
            display: none; justify-content: center; align-items: flex-end;
        }
        .modal-box {
            width: 100%; max-width: 600px;
            background: #1e293b;
            border-radius: 20px 20px 0 0;
            padding: 25px;
            max-height: 90vh; overflow-y: auto;
            display: flex; flex-direction: column;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: white; }
        .btn-close { background: none; border: none; color: #94a3b8; font-size: 2rem; line-height: 1; cursor: pointer; }

        /* INPUTS CONFIG */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.7rem; color: #94a3b8; margin-bottom: 5px; }
        .form-input { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; font-size: 1rem; }
        
        /* SEARCH DO MAPA */
        .leaflet-control-geocoder { background: white; border-radius: 4px; padding: 5px; min-width: 250px; }
        .leaflet-control-geocoder input { width: 100%; color: #000; font-size: 14px; }

    </style>
</head>
<body>

    <div class="app-header">
        <div class="brand">TAXI<span>PRO</span></div>
        <div class="header-info">
            <div class="clock" id="liveClock">00:00:00</div>
            <div class="driver" id="driverDisplay">Mot: <b>...</b></div>
        </div>
    </div>

    <div class="viewport">
        <div class="label-price">VALOR DA CORRIDA</div>
        <div class="value-price" id="displayPrice">R$ 0,00</div>

        <div class="flag-box">
            <button class="flag-btn active" id="btnFlag1" onclick="mudarBandeira(1)">BANDEIRA 1</button>
            <button class="flag-btn" id="btnFlag2" onclick="mudarBandeira(2)">BANDEIRA 2</button>
        </div>
        <div class="flag-lock" id="flagLockText">üîí HOR√ÅRIO AUTOM√ÅTICO ATIVO</div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-val" id="displayDist">0.0</div>
                <div class="stat-lbl">KM (Cobrado > 1.5)</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="displayTime">00:00</div>
                <div class="stat-lbl">TEMPO DE CORRIDA</div>
            </div>
        </div>
    </div>

    <div class="action-area">
        <div id="boxStart">
            <button class="btn-main btn-start" onclick="iniciarCorrida()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                INICIAR CORRIDA
            </button>
        </div>

        <div id="boxRunning" style="display:none; gap:10px;">
            <button class="btn-main btn-pause" onclick="pausarCorrida()" id="btnPauseIcon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            <button class="btn-main btn-stop" onclick="encerrarCorrida()" style="flex:3">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
                ENCERRAR
            </button>
        </div>
    </div>

    <div class="dock">
        <button class="dock-btn" onclick="abrirModal('modalSim')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
            Simular
        </button>
        <button class="dock-btn" onclick="carregarHistorico()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
            Hist√≥rico
        </button>
        <button class="dock-btn" onclick="shareApp()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
            App
        </button>
        <button class="dock-btn" onclick="abrirConfig()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58z"/></svg>
            Ajustes
        </button>
        <button class="dock-btn" onclick="abrirModal('modalAdmin')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
            Admin
        </button>
    </div>

    <div id="modalSim" class="modal-overlay">
        <div class="modal-box" style="height:90vh;">
            <div class="modal-header"><span class="modal-title">Simulador</span><button class="btn-close" onclick="fecharModal('modalSim')">√ó</button></div>
            <div id="simMap" style="flex:1; background:#333; border-radius:10px; min-height:300px;"></div>
            <div style="background:#0f172a; padding:15px; margin-top:10px; border-radius:10px; text-align:center;">
                <div style="font-size:0.7rem; color:#94a3b8;">ESTIMATIVA</div>
                <div id="simPrice" style="font-size:1.8rem; font-weight:bold; color:var(--primary)">R$ 0,00</div>
                <div id="simDist" style="color:white; font-size:0.9rem;">0.0 km</div>
            </div>
            <button class="btn-main btn-pause" onclick="fecharModal('modalSim')" style="margin-top:10px;">FECHAR</button>
        </div>
    </div>

    <div id="modalConfig" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span class="modal-title">Configurar Tarifas</span><button class="btn-close" onclick="fecharModal('modalConfig')">√ó</button></div>
            
            <div class="form-row">
                <div class="form-group"><label>Band 1 (R$)</label><input type="number" id="cfg_b1" class="form-input"></div>
                <div class="form-group"><label>Km 1 (R$)</label><input type="number" id="cfg_k1" class="form-input"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Band 2 (R$)</label><input type="number" id="cfg_b2" class="form-input"></div>
                <div class="form-group"><label>Km 2 (R$)</label><input type="number" id="cfg_k2" class="form-input"></div>
            </div>
            <div class="form-group"><label>Pre√ßo Minuto (R$)</label><input type="number" id="cfg_min" class="form-input"></div>
            
            <hr style="border-color:#334155; margin:15px 0;">
            <div class="form-group"><label style="color:var(--gold); font-weight:bold;">HOR√ÅRIO AUTOM√ÅTICO</label></div>
            <div class="form-row">
                <div class="form-group"><label>In√≠cio B2 (H)</label><input type="number" id="cfg_hi" class="form-input"></div>
                <div class="form-group"><label>Fim B2 (H)</label><input type="number" id="cfg_hf" class="form-input"></div>
            </div>

            <button class="btn-main btn-start" onclick="salvarConfig()">SALVAR</button>
        </div>
    </div>

    <div id="modalHist" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span class="modal-title">Hist√≥rico</span><button class="btn-close" onclick="fecharModal('modalHist')">√ó</button></div>
            <div id="histList" style="flex:1; margin-bottom:10px;"></div>
            <button class="btn-main btn-stop" onclick="limparHistorico()">LIMPAR TUDO</button>
        </div>
    </div>

    <div id="modalAdmin" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span class="modal-title">Admin</span><button class="btn-close" onclick="fecharModal('modalAdmin')">√ó</button></div>
            <div id="adminLogin">
                <input type="password" id="adminPass" class="form-input" placeholder="Senha Mestra" style="text-align:center; margin-bottom:10px;">
                <button class="btn-main btn-pause" onclick="loginAdmin()">ENTRAR</button>
            </div>
            <div id="adminPanel" style="display:none;">
                <div id="driversList">Carregando...</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // === 1. CONFIG FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyBzD2q7VWFM1jGqj-787M3AZV0_I9uFZ_s",
            authDomain: "vaga-especial-ff7d3.firebaseapp.com",
            databaseURL: "https://vaga-especial-ff7d3-default-rtdb.firebaseio.com",
            projectId: "vaga-especial-ff7d3",
            storageBucket: "vaga-especial-ff7d3.firebasestorage.app",
            messagingSenderId: "220203379880",
            appId: "1:220203379880:web:3ed69498dd1a7c3049e69d"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        const db = firebase.database();

        // === 2. DADOS ===
        let config = JSON.parse(localStorage.getItem('taxi_cfg_final')) || { 
            b1: 6.00, k1: 3.50, b2: 8.00, k2: 4.50, min: 0.50, hIni: 22, hFim: 6 
        };
        let driver = JSON.parse(localStorage.getItem('taxi_driver_final'));
        let corrida = { rodando:false, pausado:false, flag:1, manual:false, dist:0, tempo:0, valor:0 };
        let timer, watchId, lastPos, map, routeControl;

        // === 3. INICIALIZA√á√ÉO ===
        window.onload = function() {
            verificarMotorista();
            startClock();
            verificarBandeiraAuto();
            atualizarTela();
            setInterval(verificarBandeiraAuto, 60000); // Checa hor√°rio todo minuto
        };

        function startClock() {
            setInterval(() => {
                document.getElementById('liveClock').innerText = new Date().toLocaleTimeString();
            }, 1000);
        }

        async function verificarMotorista() {
            if(!driver) {
                const { value: form } = await Swal.fire({
                    title: 'Cadastro √önico',
                    html: `
                        <input id="swal-name" class="swal2-input" placeholder="Seu Nome">
                        <input id="swal-plate" class="swal2-input" placeholder="Placa do Carro">
                        <input id="swal-cel" class="swal2-input" placeholder="Celular">
                    `,
                    allowOutsideClick: false,
                    preConfirm: () => {
                        return {
                            name: document.getElementById('swal-name').value,
                            plate: document.getElementById('swal-plate').value,
                            phone: document.getElementById('swal-cel').value,
                            id: Date.now()
                        }
                    }
                });
                if(form) {
                    driver = form;
                    localStorage.setItem('taxi_driver_final', JSON.stringify(driver));
                    db.ref('drivers/' + driver.id).set(driver);
                }
            }
            if(driver) {
                document.getElementById('driverDisplay').innerHTML = `Mot: <b>${driver.name}</b>`;
            }
        }

        // === 4. L√ìGICA DE BANDEIRA E CORRIDA ===
        function verificarBandeiraAuto() {
            if(corrida.manual) return;
            const h = new Date().getHours();
            let isB2 = false;
            if(config.hIni > config.hFim) isB2 = (h >= config.hIni || h < config.hFim);
            else isB2 = (h >= config.hIni && h < config.hFim);
            
            aplicarBandeira(isB2 ? 2 : 1, true);
        }

        function mudarBandeira(n) {
            const lock = document.getElementById('flagLockText');
            if(lock.style.display === 'block') return Swal.fire('Bloqueado', 'Hor√°rio Autom√°tico Ativo', 'warning');
            corrida.manual = true;
            aplicarBandeira(n, false);
        }

        function aplicarBandeira(n, auto) {
            corrida.flag = n;
            document.getElementById('btnFlag1').className = n===1 ? 'flag-btn active' : 'flag-btn';
            document.getElementById('btnFlag2').className = n===2 ? 'flag-btn active2' : 'flag-btn';
            
            const lock = document.getElementById('flagLockText');
            if(auto) {
                lock.style.display = 'block';
                document.getElementById('btnFlag1').style.opacity = '0.5';
                document.getElementById('btnFlag2').style.opacity = '0.5';
            } else {
                lock.style.display = 'none';
                document.getElementById('btnFlag1').style.opacity = '1';
                document.getElementById('btnFlag2').style.opacity = '1';
            }
            if(corrida.rodando) calcularPreco();
            else {
                // Se parado, mostra a bandeirada inicial
                let b = n===1 ? config.b1 : config.b2;
                document.getElementById('displayPrice').innerText = `R$ ${b.toFixed(2)}`;
            }
        }

        function calcularPreco() {
            let base = corrida.flag === 1 ? config.b1 : config.b2;
            let pKm = corrida.flag === 1 ? config.k1 : config.k2;
            
            // REGRA 1.5 KM
            if(corrida.dist <= 1.5) {
                corrida.valor = base;
            } else {
                let exc = corrida.dist - 1.5;
                let custoKm = exc * pKm;
                let custoTempo = (corrida.tempo / 60) * config.min;
                corrida.valor = base + custoKm + custoTempo;
            }
            atualizarTela();
        }

        function atualizarTela() {
            document.getElementById('displayPrice').innerText = `R$ ${corrida.valor.toFixed(2)}`;
            document.getElementById('displayDist').innerText = corrida.dist.toFixed(1);
            
            let m = Math.floor(corrida.tempo / 60).toString().padStart(2,'0');
            let s = (corrida.tempo % 60).toString().padStart(2,'0');
            document.getElementById('displayTime').innerText = `${m}:${s}`;
        }

        function iniciarCorrida() {
            corrida.rodando = true; corrida.pausado = false;
            corrida.dist = 0; corrida.tempo = 0; corrida.manual = false;
            
            verificarBandeiraAuto(); // Reseta para auto ao iniciar
            
            document.getElementById('boxStart').style.display = 'none';
            document.getElementById('boxRunning').style.display = 'flex';
            
            if(navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(pos => {
                    if(corrida.rodando && !corrida.pausado) {
                        if(lastPos) {
                            let d = calcDist(lastPos.coords.latitude, lastPos.coords.longitude, pos.coords.latitude, pos.coords.longitude);
                            if(d > 0.005) { // 5 metros
                                corrida.dist += d;
                                calcularPreco();
                            }
                        }
                        lastPos = pos;
                    }
                }, null, { enableHighAccuracy: true });
            }
            
            timer = setInterval(() => {
                if(!corrida.pausado) {
                    corrida.tempo++;
                    calcularPreco();
                }
            }, 1000);
        }

        function pausarCorrida() {
            corrida.pausado = !corrida.pausado;
            const btn = document.getElementById('btnPauseIcon');
            btn.innerHTML = corrida.pausado ? '‚ñ∂' : '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            btn.style.background = corrida.pausado ? '#eab308' : '#334155';
        }

        function encerrarCorrida() {
            clearInterval(timer);
            navigator.geolocation.clearWatch(watchId);
            corrida.rodando = false;

            const dados = {
                data: new Date().toLocaleString(),
                val: corrida.valor.toFixed(2),
                dist: corrida.dist.toFixed(2),
                tempo: document.getElementById('displayTime').innerText,
                flag: corrida.flag,
                mot: driver.name,
                dest: 'Rota GPS'
            };
            db.ref('taxi_rides').push(dados);

            Swal.fire({
                title: 'Corrida Finalizada',
                html: `<h1 style="color:#22c55e">R$ ${dados.val}</h1><p>${dados.dist}km | ${dados.tempo}</p>`,
                showCancelButton: true, confirmButtonText: 'Nova Corrida', cancelButtonText: 'Recibo', cancelButtonColor: '#3b82f6'
            }).then((res) => {
                if(res.dismiss === Swal.DismissReason.cancel) {
                    const txt = `üöñ *T√°xi ${driver.name}*\nüí∞ Valor: R$ ${dados.val}\nüèÅ Dist: ${dados.dist}km\n‚è± Tempo: ${dados.tempo}`;
                    if(navigator.share) navigator.share({text:txt});
                }
                document.getElementById('boxStart').style.display = 'block';
                document.getElementById('boxRunning').style.display = 'none';
                corrida.dist = 0; corrida.tempo = 0; corrida.valor = 0;
                verificarBandeiraAuto(); // Reseta visual
            });
        }

        // === 5. AJUSTES ===
        function abrirConfig() {
            document.getElementById('cfg_b1').value = config.b1;
            document.getElementById('cfg_k1').value = config.k1;
            document.getElementById('cfg_b2').value = config.b2;
            document.getElementById('cfg_k2').value = config.k2;
            document.getElementById('cfg_min').value = config.min;
            document.getElementById('cfg_hi').value = config.hIni;
            document.getElementById('cfg_hf').value = config.hFim;
            abrirModal('modalConfig');
        }

        function salvarConfig() {
            config.b1 = parseFloat(document.getElementById('cfg_b1').value);
            config.k1 = parseFloat(document.getElementById('cfg_k1').value);
            config.b2 = parseFloat(document.getElementById('cfg_b2').value);
            config.k2 = parseFloat(document.getElementById('cfg_k2').value);
            config.min = parseFloat(document.getElementById('cfg_min').value);
            config.hIni = parseInt(document.getElementById('cfg_hi').value);
            config.hFim = parseInt(document.getElementById('cfg_hf').value);
            
            localStorage.setItem('taxi_cfg_final', JSON.stringify(config));
            fecharModal('modalConfig');
            verificarBandeiraAuto();
            Swal.fire('Salvo!', '', 'success');
        }

        // === 6. MAPA SIMULADOR ===
        function abrirModal(id) { 
            document.getElementById(id).style.display = 'flex'; 
            if(id === 'modalSim') initMap();
        }
        function fecharModal(id) { document.getElementById(id).style.display = 'none'; }

        function initMap() {
            setTimeout(() => {
                if(!map) {
                    map = L.map('simMap').setView([-21.13, -44.26], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    
                    L.Control.geocoder({ defaultMarkGeocode: false, placeholder: "Buscar destino..." })
                    .on('markgeocode', function(e) {
                        const dest = e.geocode.center;
                        tra√ßarRota(dest);
                    }).addTo(map);
                }
                map.invalidateSize();
                navigator.geolocation.getCurrentPosition(p => {
                    const me = [p.coords.latitude, p.coords.longitude];
                    map.setView(me, 14);
                    map.myPos = me;
                    L.marker(me).addTo(map).bindPopup('Voc√™').openPopup();
                });
            }, 300);
        }

        function tra√ßarRota(dest) {
            if(!map.myPos) return;
            if(routeControl) map.removeControl(routeControl);
            
            routeControl = L.Routing.control({
                waypoints: [ L.latLng(map.myPos), dest ],
                createMarker: function() { return null; }, show: false
            }).on('routesfound', function(e) {
                const dist = e.routes[0].summary.totalDistance / 1000;
                const time = e.routes[0].summary.totalTime / 60;
                
                // Simula Regra 1.5km
                let base = corrida.flag === 1 ? config.b1 : config.b2;
                let k = corrida.flag === 1 ? config.k1 : config.k2;
                let total = base;
                
                if(dist > 1.5) total += (dist - 1.5) * k;
                total += time * config.min;
                
                document.getElementById('simPrice').innerText = `R$ ${total.toFixed(2)}`;
                document.getElementById('simDist').innerText = `${dist.toFixed(1)} km | ${time.toFixed(0)} min`;
            }).addTo(map);
        }

        // === 7. ADMIN & HISTORICO ===
        function loginAdmin() {
            if(document.getElementById('adminPass').value === 'sjdr2025') {
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                carregarDrivers();
            } else Swal.fire('Erro', 'Senha inv√°lida', 'error');
        }

        function carregarDrivers() {
            db.ref('drivers').once('value').then(snap => {
                let h = '';
                snap.forEach(c => {
                    let d = c.val();
                    h += `<div style="background:#0f172a; padding:10px; margin-bottom:5px; display:flex; justify-content:space-between;"><div><b>${d.name}</b><br><small>${d.placa}</small></div><button onclick="delDriver(${d.id})" style="color:red; background:none; border:none;">BLOQ</button></div>`;
                });
                document.getElementById('driversList').innerHTML = h || 'Nenhum';
            });
        }
        function delDriver(id) { if(confirm('Bloquear?')) { db.ref('drivers/'+id).remove(); carregarDrivers(); } }

        function carregarHistorico() {
            abrirModal('modalHist');
            db.ref('taxi_rides').limitToLast(20).once('value').then(snap => {
                let h = '';
                let arr = [];
                snap.forEach(c => arr.push(c.val()));
                arr.reverse().forEach(r => {
                    h += `<div style="background:#0f172a; padding:10px; margin-bottom:5px; border-left:3px solid var(--primary);">
                        <div style="display:flex; justify-content:space-between;"><b>R$ ${r.val}</b> <small>${r.data}</small></div>
                        <small style="color:#aaa">${r.dist}km | ${r.tempo} | ${r.mot}</small>
                    </div>`;
                });
                document.getElementById('histList').innerHTML = h || 'Vazio';
            });
        }
        function limparHistorico() { if(confirm('Apagar tudo?')) { db.ref('taxi_rides').remove(); document.getElementById('histList').innerHTML=''; }}
        function shareApp() { if(navigator.share) navigator.share({title:'TaxiPro', url:window.location.href}); }
        function calcDist(lat1, lon1, lat2, lon2) { const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }

    </script>
</body>
</html>
